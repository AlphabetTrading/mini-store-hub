// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  WAREHOUSE_MANAGER
  RETAIL_SHOP_MANAGER
}

model User {
  id               String  @id @default(cuid())
  firstName        String
  lastName         String
  username         String  @unique
  phone            String  @unique
  password         String
  amharicFirstName String? @map("የ መጀመሪያ ስም") @db.Text
  amharicLastName  String? @map("የ አባት ስም") @db.Text

  role      UserRole @default(USER)
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProfile        UserProfile?
  retailShop         RetailShop[]        @relation("RetailShopManager")
  warehouse          Warehouse[]         @relation("WarehouseManager")
  notificationTokens NotificationToken[] @relation("NotificationToken")
  notifications      Notification[]      @relation("Notifications")

  @@index([username, phone])
}

enum RecipientType {
  USER
  RETAIL_SHOP
  WAREHOUSE
  ALL
}

model Notification {
  id                String             @id @default(cuid())
  title             String
  amharicTitle      String?            @map("የ ርዕስ ስም") @db.Text
  body              String
  amharicBody       String?            @map("መልእክት") @db.Text
  status            Boolean            @default(false)
  recipientType     RecipientType      @default(USER)
  recipientId       String?
  isRead            Boolean
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  notificationReads NotificationRead[] @relation("ReadNotification")
  user              User?              @relation("Notifications", fields: [userId], references: [id])
  userId            String?
}

model NotificationRead {
  id             String       @id @default(cuid())
  notificationId String
  userId         String
  notification   Notification @relation("ReadNotification", fields: [notificationId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([notificationId, userId])
}

model NotificationToken {
  id          String   @id @default(cuid())
  device_type String
  token       String   @unique
  status      Boolean  @default(false)
  userId      String
  user        User     @relation("NotificationToken", fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  photoUrl  String?
  idUrl     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  addressId String?  @unique
  address   Address? @relation("User Address", fields: [addressId], references: [id])
}

model Category {
  id                 String     @id @default(cuid())
  name               String     @unique
  amharicName        String?    @map("የ እቃ ክፍል ስም") @db.Text
  description        String
  amharicDescription String?    @map("መግለጫ") @db.Text
  parentId           String?
  parent             Category?  @relation("Subcategory", fields: [parentId], references: [id])
  subcategories      Category[] @relation("Subcategory")
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  products           Product[]
}

enum UnitType {
  PIECES
  KG
  LITER
  METER
  METER_SQUARE
  BOX
  BAG
  BOTTLE
  OTHER
}

model Product {
  id                String   @id @default(cuid())
  serialNumber      String
  name              String
  // amharicName field contains the title of the product in amharic character
  amharicName       String?  @map("የ እቃ ስም") @db.Text
  description       String
  // amharicDescription field contains the description of the product in amharic character
  amharicDecription String?  @map("መግለጫ") @db.Text
  categoryId        String
  category          Category @relation(fields: [categoryId], references: [id])
  unit              UnitType
  images            String[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  activePriceId String?        @unique
  activePrice   PriceHistory?  @relation("ActivePrice", fields: [activePriceId], references: [id])
  priceHistory  PriceHistory[] @relation("PriceHistory")

  retailShopStock     RetailShopStock[]
  warehouseStock      WarehouseStock[]
  goods               StockItem[]
  saleTransactionItem SaleTransactionItem[]

  @@unique([id, createdAt])
}

model PriceHistory {
  id             String   @id @default(cuid())
  productId      String
  price          Float
  purchasedPrice Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  activeProduct  Product? @relation("ActivePrice")
  product        Product  @relation("PriceHistory", fields: [productId], references: [id])
}

model Address {
  id                      String       @id @default(cuid())
  street                  String?
  city                    String?
  lng                     Float?
  lat                     Float?
  formattedAddress        String?
  amharicFormattedAddress String?      @map("ሙሉ አድራሻ") @db.Text
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  retailShop              RetailShop?  @relation("RetailShop Address")
  warehouse               Warehouse?   @relation("Warehouse Address")
  userProfile             UserProfile? @relation("User Address")
}

model RetailShop {
  id                  String   @id @default(cuid())
  name                String
  amharicName         String?  @map("የስራ ቦታ ስም") @db.Text
  addressId           String?  @unique
  address             Address? @relation("RetailShop Address", fields: [addressId], references: [id])
  retailShopManagerId String?
  retailShopManager   User?    @relation("RetailShopManager", fields: [retailShopManagerId], references: [id])
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  saleTransaction             SaleTransaction[]
  retailShopStock             RetailShopStock[]
  goodsTransfersAsDestination GoodsTransfer[]      @relation("DestinationShop")
  dailyTransaction            DailyTransaction[]
  monthlyTransaction          MonthlyTransaction[]
  annualTransaction           AnnualTransaction[]
}

model Warehouse {
  id                 String   @id @default(cuid())
  name               String
  amharicName        String?  @map("የስራ ቦታ ስም") @db.Text
  addressId          String?  @unique
  warehouseManagerId String?
  isMain             Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  address                     Address?          @relation("Warehouse Address", fields: [addressId], references: [id])
  warehouseManager            User?             @relation("WarehouseManager", fields: [warehouseManagerId], references: [id])
  goodsTransfersAsSource      GoodsTransfer[]   @relation("SourceWarehouse")
  warehouseStock              WarehouseStock[]
  retailShopStock             RetailShopStock[]
  goodsTransfersAsDestination GoodsTransfer[]   @relation("DestinationWarehouse")
}

enum TransferType {
  WarehouseToWarehouse
  WarehouseToRetailShop
}

model GoodsTransfer {
  id                     String       @id @default(cuid())
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  retailShopId           String?
  retailShop             RetailShop?  @relation("DestinationShop", fields: [retailShopId], references: [id])
  sourceWarehouseId      String
  sourceWarehouse        Warehouse    @relation("SourceWarehouse", fields: [sourceWarehouseId], references: [id])
  destinationWarehouseId String?
  destinationWarehouse   Warehouse?   @relation("DestinationWarehouse", fields: [destinationWarehouseId], references: [id])
  transferType           TransferType @default(WarehouseToWarehouse)
  goods                  StockItem[]  @relation("Goods Transfer")
}

model StockItem {
  id              String        @id @default(cuid())
  goodsTransferId String
  productId       String
  product         Product?      @relation(fields: [productId], references: [id])
  quantity        Float
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  goodsTransfer   GoodsTransfer @relation("Goods Transfer", fields: [goodsTransferId], references: [id])
}

model SaleTransaction {
  id                   String                @id @default(cuid())
  totalPrice           Float
  retailShopId         String
  retailShop           RetailShop            @relation(fields: [retailShopId], references: [id])
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  saleTransactionItems SaleTransactionItem[] @relation("SaleTransaction")
}

model SaleTransactionItem {
  id                String          @id @default(cuid())
  productId         String
  product           Product         @relation(fields: [productId], references: [id])
  quantity          Float
  price             Float
  subTotal          Float
  saleTransactionId String
  saleTransaction   SaleTransaction @relation("SaleTransaction", fields: [saleTransactionId], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model RetailShopStock {
  id           String     @id @default(cuid())
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  warehouseId  String
  warehouse    Warehouse  @relation(fields: [warehouseId], references: [id])
  quantity     Float
  maxQuantity  Float
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  retailShop   RetailShop @relation(fields: [retailShopId], references: [id])
  retailShopId String

  @@unique([productId, retailShopId])
}

model WarehouseStock {
  id          String    @id @default(cuid())
  productId   String
  warehouseId String
  quantity    Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])

  @@unique([productId, warehouseId])
}

model DailyTransaction {
  id           String     @id @default(cuid())
  retailShopId String
  date         DateTime
  totalSales   Float
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  retailShop   RetailShop @relation(fields: [retailShopId], references: [id])
}

model MonthlyTransaction {
  id           String     @id @default(cuid())
  retailShopId String
  month        String
  totalSales   Float
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  retailShop   RetailShop @relation(fields: [retailShopId], references: [id])
}

model AnnualTransaction {
  id           String     @id @default(cuid())
  retailShopId String
  year         String
  totalSales   Float
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  retailShop   RetailShop @relation(fields: [retailShopId], references: [id])
}
